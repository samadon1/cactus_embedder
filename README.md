# Cactus Embedder

A Flutter-based tool for pre-computing embeddings using the [Cactus SDK](https://pub.dev/packages/cactus). Generate embeddings for JSON datasets and PDF documents with automatic checkpointing and resume capability.

## Inspiration

This project was born out of a real-world challenge while building **MamaWise**, a maternal health chatbot for Ghana that uses on-device AI to provide health information in Twi-English (code-mixed language).

MamaWise needed to embed 20,000 Q&A pairs for its RAG (Retrieval-Augmented Generation) system. The problem? Generating embeddings at app startup would take **6+ hours** - an unacceptable user experience.

We searched for a pre-computing solution in the Cactus ecosystem but found none existed. That's when we realized: **every developer building RAG applications with Cactus will face this same problem**.

So we built Cactus Embedder to solve it - not just for ourselves, but for the entire Cactus community.

## The Problem It Solves

### Why Can't I Just Use Python?

If you're familiar with AI/ML workflows, you might wonder: "Why not use Python's `sentence-transformers` or OpenAI's API to pre-compute embeddings?"

The answer: **incompatible vector spaces**.

Different embedding models produce vectors that live in completely different mathematical spaces. An embedding from `sentence-transformers` cannot be compared with one from Cactus's `qwen3-0.6-embed` - the similarity scores would be meaningless.

```
Python (sentence-transformers)  →  Vector Space A
OpenAI (text-embedding-ada)     →  Vector Space B
Cactus (qwen3-0.6-embed)        →  Vector Space C  ← Your app uses this
```

To use pre-computed embeddings in your Cactus app, they **must** be generated by the same Cactus model you'll use at runtime.

### Why Can't I Use a Dart CLI?

Cactus SDK requires Flutter's platform channels to communicate with the native llama.cpp backend. A pure Dart CLI cannot access these platform-specific bindings.

This means embedding generation must happen inside a Flutter application context - which is exactly what Cactus Embedder provides.

### The Runtime Problem

Without pre-computed embeddings, your app faces a painful first-launch experience:

| Dataset Size | Embedding Time | User Experience |
|--------------|----------------|-----------------|
| 1,000 items | ~15 minutes | Frustrating |
| 10,000 items | ~2.5 hours | Unusable |
| 20,000 items | ~6 hours | App abandoned |

With Cactus Embedder, you shift this work to build time. Your app ships with ready-to-use embeddings, and users get instant semantic search from the first launch.

## Features

- **JSON Support**: Process Q&A pairs, document collections, or any structured data
- **PDF Support**: Extract text from PDFs, automatically chunk, and embed
- **PDF Directory**: Batch process entire folders of PDF documents
- **Smart Chunking**: Sentence-aware text splitting with configurable overlap
- **Checkpointing**: Saves progress every N items (default: 100)
- **Resume Capability**: Restart interrupted jobs without losing progress
- **Multiple Models**: Support for `qwen3-0.6-embed` (1024d) and `nomic-embed-text-v2` (768d)
- **Rich Metadata**: Preserves source info, page numbers, chunk indices
- **Visual Progress**: GUI window shows real-time progress and statistics

## Installation

```bash
# Clone the repository
git clone https://github.com/YOUR_USERNAME/cactus_embedder.git
cd cactus_embedder

# Get dependencies
flutter pub get
```

## Usage

### JSON Files

```bash
# Basic usage - embed Q&A pairs
flutter run -d macos -- -i qa_pairs.json -o qa_with_embeddings.json

# Custom text field
flutter run -d macos -- -i data.json -o out.json --text-field content

# Different model
flutter run -d macos -- -i data.json -o out.json -m nomic-embed-text-v2
```

### PDF Files

```bash
# Single PDF
flutter run -d macos -- -i document.pdf -o embeddings.json --input-type pdf

# Directory of PDFs
flutter run -d macos -- -i ./documents/ -o embeddings.json --input-type pdf-dir

# Custom chunk settings
flutter run -d macos -- -i doc.pdf -o out.json --input-type pdf --chunk-size 1000 --chunk-overlap 100
```

### All Options

| Option | Short | Default | Description |
|--------|-------|---------|-------------|
| `--input` | `-i` | Required | Input file or directory path |
| `--output` | `-o` | Required | Output JSON file path |
| `--input-type` | - | `json` | Input type: `json`, `pdf`, or `pdf-dir` |
| `--model` | `-m` | `qwen3-0.6-embed` | Embedding model to use |
| `--text-field` | `-t` | `question` | JSON field containing text to embed |
| `--chunk-size` | `-c` | `500` | Chunk size in characters (for PDFs) |
| `--chunk-overlap` | - | `50` | Overlap between chunks (for PDFs) |
| `--batch-size` | `-b` | `100` | Save checkpoint every N items |
| `--resume` | `-r` | `true` | Resume from existing output |
| `--help` | `-h` | - | Show help message |

## Input/Output Formats

### JSON Input

```json
{
  "qa_pairs": [
    {
      "id": "Q001",
      "question": "What is maternal health?",
      "answer": "Maternal health refers to..."
    }
  ]
}
```

### JSON Output

```json
{
  "qa_pairs": [
    {
      "id": "Q001",
      "question": "What is maternal health?",
      "answer": "Maternal health refers to...",
      "embeddings": [0.123, -0.456, 0.789, ...]
    }
  ],
  "_embedder_metadata": {
    "model": "qwen3-0.6-embed",
    "total_items": 20000,
    "embedded_count": 20000,
    "generated_at": "2025-01-15T10:30:00Z",
    "tool": "cactus_embedder v1.1.0"
  }
}
```

### PDF Output

```json
{
  "input_type": "pdf",
  "source_file": "document.pdf",
  "chunk_size": 500,
  "chunk_overlap": 50,
  "chunks": [
    {
      "id": "document_p1_c0",
      "text": "Extracted text content...",
      "embeddings": [0.123, -0.456, ...],
      "metadata": {
        "source": "document.pdf",
        "page": 1,
        "total_pages": 10,
        "chunk_index": 0,
        "chunks_in_page": 3
      }
    }
  ]
}
```

## Supported Models

| Model | Dimensions | Best For |
|-------|------------|----------|
| `qwen3-0.6-embed` | 1024 | General purpose, highest quality |
| `nomic-embed-text-v2` | 768 | Faster processing, good quality |

## Performance

On Apple Silicon (M1/M2/M3):

| Model | Speed | 20K Items |
|-------|-------|-----------|
| qwen3-0.6-embed | ~1-2 items/sec | ~3-6 hours |
| nomic-embed-text-v2 | ~2-3 items/sec | ~2-3 hours |

The checkpointing system means you can pause anytime and resume later - no progress lost.

## Integration Example

After generating embeddings, load them in your Cactus app:

```dart
// Load pre-computed embeddings
final jsonString = await rootBundle.loadString('assets/qa_with_embeddings.json');
final data = json.decode(jsonString);

// Insert into your vector store (e.g., ObjectBox with HNSW)
for (final qa in data['qa_pairs']) {
  final item = QAPair()
    ..question = qa['question']
    ..answer = qa['answer']
    ..embeddings = List<double>.from(qa['embeddings']);
  box.put(item);
}

// Semantic search is now instant!
final results = box.query()
  .nearestNeighbors(QAPair_.embeddings, queryEmbedding, 5)
  .find();
```

## Future Roadmap

We're actively developing Cactus Embedder. Here's what's planned:

### Short Term
- [ ] **Batch file processing**: Process multiple JSON files in one run
- [ ] **Progress persistence**: Save state to disk for multi-session runs
- [ ] **Parallel processing**: Utilize multiple CPU cores for faster embedding

### Medium Term
- [ ] **Web UI**: Browser-based interface for non-technical users
- [ ] **Docker image**: Containerized version for CI/CD pipelines
- [ ] **Output formats**: Support for Parquet, SQLite, and direct vector DB exports

### Long Term
- [ ] **Cloud processing**: Distributed embedding across multiple machines
- [ ] **Model fine-tuning**: Custom embedding models for domain-specific applications
- [ ] **Integration plugins**: Direct export to Pinecone, Weaviate, Qdrant

### Community Wishlist
Have a feature request? Open an issue! We built this tool for the community and want it to solve real problems.

## Platform Support

| Platform | Status |
|----------|--------|
| macOS (Apple Silicon) | Fully supported |
| macOS (Intel) | Fully supported |
| Linux | Supported |
| Windows | Supported |

Note: Requires Flutter SDK installed. The tool runs as a Flutter application to access Cactus SDK's native bindings.

## Contributing

This tool was created to fill a gap in the Cactus ecosystem. We welcome contributions!

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## Acknowledgments

- **Cactus Team** - For building an amazing on-device AI SDK
- **MamaWise Project** - The maternal health app that inspired this tool
- **Flutter Community** - For the excellent cross-platform framework

## License

MIT License - Feel free to use in your own projects!

---

Built with love for the Cactus community. If this tool helps your project, consider giving it a star!
